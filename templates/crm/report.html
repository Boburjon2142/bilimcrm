{% extends "crm/base.html" %}
{% load humanize %}

{% block title %}Hisobot{% endblock %}

{% block extra_css %}
<style>
  .report-page { max-width:1100px; margin:0 auto; }
  .report-header h4 { font-size:34px; font-weight:800; color:#1f2937; }
  .report-header .range { font-size:16px; color:#6b7280; }
  .report-card { border-radius:18px; border:1px solid #e6e6e6; box-shadow:0 12px 22px rgba(16,42,67,0.08); background:#f7f7f9; }
  .report-kpi { font-size:28px; font-weight:800; }
  .report-kpi.green { color:#15803d; }
  .report-kpi.red { color:#b91c1c; }
  .report-table th { font-size:12px; text-transform:uppercase; letter-spacing:0.04em; color:#64748b; }
  .filter-card { background:#fff; border:1px solid #e5e7eb; border-radius:18px; padding:16px; box-shadow:0 10px 20px rgba(0,0,0,0.05); }
  .filter-grid { display:grid; grid-template-columns:1fr auto 1fr auto; gap:16px; align-items:center; }
  .filter-divider { width:1px; height:44px; background:#e5e7eb; }
  .filter-group label { font-size:13px; color:#6b7280; margin-bottom:6px; }
  .filter-input { display:flex; align-items:center; gap:8px; border:1px solid #e5e7eb; border-radius:12px; padding:8px 10px; background:#fff; }
  .filter-input input { border:0; outline:0; background:transparent; width:100%; }
  .filter-btn { border-radius:10px; padding:8px 18px; }
  .range-tabs { display:flex; gap:8px; background:#f1f5f9; padding:6px; border-radius:12px; }
  .range-tab { padding:6px 14px; border-radius:10px; color:#334155; text-decoration:none; font-weight:600; }
  .range-tab.active { background:#2563eb; color:#fff; }
  .section-title { font-weight:700; color:#1f2937; }
  .crm-section-link { font-size:13px; color:#1e3a8a; text-decoration:none; font-weight:600; }
  .report-form .form-control { border-radius:12px; }
  .report-form button { border-radius:12px; }
  .report-list { background:#fff; border:1px solid #e5e7eb; border-radius:16px; }
  .expense-strip { display:flex; gap:12px; overflow-x:auto; padding:6px 2px 8px; scroll-snap-type:x mandatory; -ms-overflow-style:none; scrollbar-width:none; }
  .expense-strip::-webkit-scrollbar { display:none; }
  .expense-card { flex:0 0 auto; width:220px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:14px; padding:12px; scroll-snap-align:start; box-shadow:0 8px 16px rgba(15,23,42,0.06); }
  .expense-title { font-weight:700; font-size:14px; color:#111827; margin-bottom:6px; }
  .expense-meta { font-size:12px; color:#64748b; }
  .expense-amount { font-size:15px; font-weight:700; color:#b91c1c; }
  .debt-strip { display:flex; gap:12px; overflow-x:auto; padding:6px 2px 8px; scroll-snap-type:x mandatory; -ms-overflow-style:none; scrollbar-width:none; }
  .debt-strip::-webkit-scrollbar { display:none; }
  .debt-card { flex:0 0 auto; width:220px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:14px; padding:12px; scroll-snap-align:start; box-shadow:0 8px 16px rgba(15,23,42,0.06); }
  .debt-title { font-weight:700; font-size:14px; color:#111827; margin-bottom:6px; }
  .debt-meta { font-size:12px; color:#64748b; }
  .debt-amount { font-size:15px; font-weight:700; color:#b91c1c; }
  @media (max-width: 576px) {
    .report-header h4 { font-size:26px; }
    .report-kpi { font-size:20px; }
    .filter-grid { grid-template-columns:1fr; }
    .filter-divider { display:none; }
    .range-tabs { justify-content:flex-start; }
  }
</style>
{% endblock %}

{% block content %}
<div class="report-page">
  <div class="report-header mb-3">
    <h4 class="mb-1">Hisobot</h4>
    <div class="range">{{ month_start|date:"Y-m-d" }} â€” {{ month_end|date:"Y-m-d" }}</div>
  </div>

  <div class="filter-card mb-4">
    <form method="get">
      <div class="filter-grid">
        <div class="filter-group">
          <label>Boshlanish</label>
          <div class="filter-input">
            <input type="date" name="start" value="{{ start_date|date:'Y-m-d' }}">
            <i class="bi bi-calendar3 text-muted"></i>
          </div>
        </div>
        <div class="filter-divider"></div>
        <div class="filter-group">
          <label>Tugash</label>
          <div class="filter-input">
            <input type="date" name="end" value="{{ end_date|date:'Y-m-d' }}">
            <i class="bi bi-calendar3 text-muted"></i>
          </div>
        </div>
        <button class="btn btn-primary filter-btn" type="submit">Filter</button>
      </div>
      <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
        <div class="range-tabs">
          {% for item in quick_ranges %}
          <a class="range-tab {% if item.is_active %}active{% endif %}" href="{% url 'crm_report' %}?start={{ item.start|date:'Y-m-d' }}&end={{ item.end|date:'Y-m-d' }}&start_time={{ start_time }}&end_time={{ end_time }}">{{ item.label }}</a>
          {% endfor %}
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="text-muted small">Boshlanish</span>
          <input class="form-control form-control-sm" type="time" name="start_time" value="{{ start_time }}">
          <span class="text-muted small">Tugash</span>
          <input class="form-control form-control-sm" type="time" name="end_time" value="{{ end_time }}">
        </div>
        <a class="btn btn-sm btn-outline-primary" href="{% url 'crm_export_monthly_report_pdf' %}?start={{ month_start|date:'Y-m-d' }}&end={{ month_end|date:'Y-m-d' }}&start_time={{ start_time }}&end_time={{ end_time }}">Yuklab olish</a>
      </div>
    </form>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-12 col-md-4">
      <div class="report-card p-3">
        <div class="text-muted small">Oylik kirim (sotuv)</div>
        <div class="report-kpi green">{{ income_total|floatformat:0|intcomma }} so'm</div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="report-card p-3">
        <div class="text-muted small">Oylik chiqim</div>
        <div class="report-kpi red">{{ expense_total|floatformat:0|intcomma }} so'm</div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="report-card p-3">
        <div class="text-muted small">Qoldiq</div>
        <div class="report-kpi">{{ net_total|floatformat:0|intcomma }} so'm</div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-5">
      <div class="report-card p-3">
        <div class="section-title mb-2">Chiqim qo'shish</div>
        <form method="post" class="d-grid gap-2 report-form">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="expense">
          <input class="form-control" type="text" name="title" placeholder="Sarlavha" required>
          <input class="form-control" type="number" name="amount" step="0.01" placeholder="Summa" required>
          <input class="form-control" type="date" name="spent_on">
          <textarea class="form-control" name="note" rows="2" placeholder="Izoh (ixtiyoriy)"></textarea>
          <button class="btn btn-danger" type="submit">Chiqimni saqlash</button>
        </form>
      </div>
    </div>
    <div class="col-12 col-lg-7">
      <div class="report-card p-3 report-list">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="section-title">Chiqimlar ro'yxati</div>
          <a class="crm-section-link" href="{% url 'crm_expenses' %}">Hammasi <i class="bi bi-chevron-right"></i></a>
        </div>
        <div class="expense-strip">
          {% for expense in expenses %}
          <div class="expense-card">
            <div class="expense-title">{{ expense.title }}</div>
            <div class="expense-meta">{{ expense.spent_on|date:"Y-m-d" }}</div>
            <div class="expense-amount mt-2">{{ expense.amount|floatformat:0|intcomma }} so'm</div>
          </div>
          {% empty %}
          <div class="text-muted">Chiqimlar yo'q</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-12 col-lg-5">
      <div class="report-card p-3">
        <div class="section-title mb-2">Qarz qo'shish</div>
        <form method="post" class="d-grid gap-2 report-form">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="debt">
          <input class="form-control" type="text" name="title" placeholder="F.I.Sh" required>
          <input class="form-control" type="text" name="phone" placeholder="Telefon (ixtiyoriy)">
          <input class="form-control" type="number" name="amount" step="0.01" placeholder="Qarz summasi" required>
          <textarea class="form-control" name="note" rows="2" placeholder="Izoh (ixtiyoriy)"></textarea>
          <button class="btn btn-danger" type="submit">Qarzni saqlash</button>
        </form>
      </div>
    </div>
    <div class="col-12 col-lg-7">
      <div class="report-card p-3 report-list">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="section-title">Qarzdorlar ro'yxati</div>
          <a class="crm-section-link" href="{% url 'crm_debts' %}">Hammasi <i class="bi bi-chevron-right"></i></a>
        </div>
        <div class="debt-strip">
          {% for debt in debts %}
          <div class="debt-card">
            <div class="debt-title">{{ debt.full_name }}</div>
            <div class="debt-meta">{{ debt.phone|default:"-" }}</div>
            <div class="debt-amount mt-2">{{ debt.amount|floatformat:0|intcomma }} so'm</div>
          </div>
          {% empty %}
          <div class="text-muted">Qarzdorlar yo'q</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
