{% extends "crm/base.html" %}
{% load humanize %}

{% block title %}CRM Dashboard{% endblock %}

{% block extra_css %}
<style>
  .line-chart { width:100%; }
  .line-chart-title { font-weight:700; color:#1f2937; font-size:20px; }
  .line-chart-card { border-radius:26px; background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(243,247,255,0.98)); box-shadow:0 18px 40px rgba(15,23,42,0.12); padding:24px; }
  .line-chart-canvas { position:relative; height:240px; margin-top:16px; border-radius:18px; background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(237,242,255,0.9)); overflow:hidden; }
  .line-chart-canvas::before { content:""; position:absolute; inset:0; background:linear-gradient(#e5e7eb 1px, transparent 1px); background-size:100% 40px; opacity:0.8; }
  .line-chart-canvas svg { position:absolute; inset:0; width:100%; height:100%; }
  .line-chart-line { fill:none; stroke:#4f8df6; stroke-width:4; stroke-linecap:round; filter:drop-shadow(0 10px 18px rgba(79,141,246,0.25)); }
  .line-chart-area { fill:url(#lineArea); }
  .line-chart-dot { fill:#fff; stroke:#7aa8ff; stroke-width:3; }
  .line-chart-dot.is-peak { fill:#e0f2ff; stroke:#3b82f6; stroke-width:4; }
  .line-chart-y { position:absolute; inset:0; pointer-events:none; }
  .line-chart-y span { position:absolute; left:10px; transform:translateY(-50%); font-size:12px; color:#6b7280; background:transparent; }
  .line-chart-x { display:grid; grid-template-columns:repeat(auto-fit, minmax(38px, 1fr)); gap:12px; margin-top:8px; }
  .line-chart-x span { text-align:center; font-size:12px; color:#6b7280; }
  .chart-tooltip { position:absolute; background:linear-gradient(180deg, #73a6ff, #4f8df6); color:#fff; font-weight:700; padding:6px 12px; border-radius:12px; font-size:14px; box-shadow:0 12px 22px rgba(59,130,246,0.3); transform:translate(-50%, -100%); white-space:nowrap; }
  .chart-tooltip::after { content:""; position:absolute; left:50%; bottom:-6px; transform:translateX(-50%); width:12px; height:12px; background:#4f8df6; clip-path:polygon(50% 100%, 0 0, 100% 0); }
  .crm-section-head { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
  .crm-section-title { font-weight:700; color:#0f172a; }
  .crm-section-link { font-size:13px; color:#1e3a8a; text-decoration:none; font-weight:600; }
  .crm-strip { display:flex; gap:12px; overflow-x:auto; padding:4px 2px 10px; scroll-snap-type:x mandatory; -ms-overflow-style:none; scrollbar-width:none; }
  .crm-strip::-webkit-scrollbar { display:none; }
  .crm-tile { flex:0 0 auto; width:200px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:14px; padding:12px; scroll-snap-align:start; box-shadow:0 6px 14px rgba(15,23,42,0.06); }
  .crm-tile-title { font-weight:700; font-size:14px; color:#111827; margin-bottom:6px; }
  .crm-tile-meta { font-size:12px; color:#64748b; }
  .courier-strip { display:flex; gap:12px; overflow-x:auto; padding:4px 2px 10px; scroll-snap-type:x mandatory; -ms-overflow-style:none; scrollbar-width:none; }
  .courier-strip::-webkit-scrollbar { display:none; }
  .courier-chip { flex:0 0 auto; width:110px; text-align:center; scroll-snap-align:center; }
  .courier-chip .avatar { width:70px; height:70px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#0f172a; background:#e2e8f0; border:3px solid #fff; box-shadow:0 8px 18px rgba(0,0,0,0.12); margin:0 auto 6px; }
  .courier-chip .name { font-weight:600; font-size:12px; color:#111; }
  .courier-chip .meta { font-size:11px; color:#64748b; }
  @media (max-width: 576px) {
    .weekly-chart { height:150px; gap:8px; }
    .weekly-bar .bar { max-width:22px; }
    .weekly-bar .label { font-size:10px; }
    .weekly-bar .value { font-size:9px; }
    .courier-chip { width:90px; }
    .courier-chip .avatar { width:64px; height:64px; }
    .line-chart-card { padding: 16px; border-radius: 20px; }
    .line-chart-title { font-size: 18px; }
    .line-chart-canvas { height: 200px; }
    .line-chart-y span { font-size: 10px; left: 6px; }
    .chart-tooltip { display: none; }
    .line-chart-x { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 10px; scroll-snap-type: x mandatory; }
    .line-chart-x span { min-width: 52px; white-space: nowrap; scroll-snap-align: center; }
    .line-chart-x::-webkit-scrollbar { height: 8px; }
    .line-chart-x::-webkit-scrollbar-track { background: transparent; }
    .line-chart-x::-webkit-scrollbar-thumb {
      background-color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      box-shadow: inset 0 2px 3px rgba(255,255,255,0.9), inset 0 -2px 3px rgba(148,163,184,0.6);
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='36' viewBox='0 0 120 36'><rect x='6' y='6' width='108' height='24' rx='12' fill='%23eef2f7'/><path d='M24 18h72' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round'/><path d='M30 12l-6 6 6 6' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/><path d='M90 12l6 6-6 6' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>");
      background-repeat: no-repeat;
      background-position: center;
      background-size: 70px 20px;
    }
    .line-chart-x { scrollbar-width: thin; scrollbar-color: #e5e7eb transparent; }
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
  <h4 class="mb-0">Dashboard</h4>
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-sm btn-outline-primary" href="{% url 'crm_export_report_pdf' %}">Hisobot PDF</a>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-12">
    <div class="line-chart-card">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div class="line-chart-title">Soatlik tushum</div>
        <div class="text-muted">Bugun 08:00-20:00</div>
      </div>
      <div class="line-chart">
        <div class="line-chart-canvas">
          <div class="line-chart-y">
            {% for tick in chart_ticks %}
            <span style="top: {{ tick.y }}px;">{{ tick.value|floatformat:0|intcomma }}</span>
            {% endfor %}
          </div>
          {% if chart_peak %}
          <div class="chart-tooltip" style="left: {{ chart_peak.x }}px; top: {{ chart_peak.y }}px;">
            {{ chart_peak.value|floatformat:0|intcomma }}
          </div>
          {% endif %}
          <svg viewBox="0 0 700 200" preserveAspectRatio="none" aria-hidden="true">
            <defs>
              <linearGradient id="lineArea" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#6ea8fe" stop-opacity="0.45"></stop>
                <stop offset="100%" stop-color="#6ea8fe" stop-opacity="0.05"></stop>
              </linearGradient>
            </defs>
            <polygon class="line-chart-area" points="{{ chart_points }} 630,170 50,170"></polygon>
            <polyline class="line-chart-line" points="{{ chart_points }}"></polyline>
            {% for dot in chart_dots %}
            <circle class="line-chart-dot {% if chart_peak and dot.x == chart_peak.x and dot.y == chart_peak.y %}is-peak{% endif %}" cx="{{ dot.x }}" cy="{{ dot.y }}" r="5"></circle>
            {% endfor %}
          </svg>
        </div>
        <div class="line-chart-x">
          {% for day in hourly_data %}
          <span>{{ day.label }}</span>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-2 g-md-4 mb-4 kpi-grid">
  <div class="col-6 col-md-3">
    <div class="card crm-card p-3 kpi-card kpi-amber">
      <div class="text-muted small">Bugungi buyurtmalar</div>
      <div class="crm-kpi">{{ orders_today|intcomma }}</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card crm-card p-3 kpi-card kpi-green">
      <div class="text-muted small">Bugungi tushum</div>
      <div class="crm-kpi">{{ revenue_today|floatformat:0|intcomma }} so'm</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card crm-card p-3 kpi-card kpi-blue">
      <div class="text-muted small">Jami buyurtmalar</div>
      <div class="crm-kpi">{{ total_orders|intcomma }}</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card crm-card p-3 kpi-card kpi-lilac">
      <div class="text-muted small">Jami tushum</div>
      <div class="crm-kpi">{{ total_revenue|floatformat:0|intcomma }} so'm</div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-12">
    <div class="card crm-card p-3">
      <div class="crm-section-head">
        <div class="crm-section-title">Eng ko'p sotilgan kitoblar</div>
        <a class="crm-section-link" href="{% url 'crm_orders' %}">Hammasi <i class="bi bi-chevron-right"></i></a>
      </div>
      <div class="crm-strip">
        {% for item in top_books %}
        <div class="crm-tile">
          <div class="crm-tile-title">{{ item.book__title }}</div>
          <div class="crm-tile-meta">Soni: {{ item.quantity|intcomma }}</div>
          <div class="crm-tile-meta">Tushum: {{ item.revenue|floatformat:0|intcomma }}</div>
        </div>
        {% empty %}
        <div class="text-muted">Ma'lumot yo'q</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div class="card crm-card p-3 mt-4">
  <div class="fw-semibold mb-2">Ma'lumotlar bazasini tozalash</div>
  <form method="post" action="{% url 'crm_cleanup' %}" class="row g-2 align-items-end">
    {% csrf_token %}
    <div class="col-md-4">
      <label class="form-label">Necha kundan eski</label>
      <input type="number" name="days" class="form-control" value="90" min="0" max="3650">
    </div>
    <div class="col-md-4">
      <label class="form-label">Qaysi buyurtmalar</label>
      <select name="scope" class="form-select">
        <option value="closed">Yopilgan/Bekor qilingan</option>
        <option value="all">Barchasi (to'langan ham)</option>
      </select>
    </div>
    <div class="col-md-4">
      <button class="btn btn-danger w-100 mt-4" type="submit">Tozalash</button>
    </div>
  </form>
</div>
{% endblock %}
