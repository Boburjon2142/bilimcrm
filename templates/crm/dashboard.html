{% extends "crm/base.html" %}
{% load humanize %}

{% block title %}CRM Dashboard{% endblock %}

{% block extra_css %}
<style>
  .line-chart { width:100%; }
  .line-chart-title { font-weight:700; color:#0f172a; font-size:20px; }
  .line-chart-card { border-radius:20px; background:#fff; box-shadow:0 14px 30px rgba(15,23,42,0.08); padding:22px; border:1px solid rgba(148, 163, 184, 0.2); }
  .line-chart-canvas { position:relative; height:220px; margin-top:16px; border-radius:16px; background:linear-gradient(180deg, rgba(248,250,255,0.95), rgba(239,246,255,0.7)); overflow:hidden; }
  .line-chart-canvas::before { content:""; position:absolute; inset:0; background:linear-gradient(#e2e8f0 1px, transparent 1px); background-size:100% 44px; opacity:0.7; }
  .line-chart-canvas svg { position:absolute; inset:0; width:100%; height:100%; z-index: 2; }
  .chart-bars { position:absolute; inset:18px 18px 28px 18px; display:grid; grid-template-columns:repeat(var(--chart-cols, 13), minmax(22px, 1fr)); gap:10px; align-items:end; z-index: 1; }
  .chart-bar { position:relative; display:flex; align-items:flex-end; justify-content:center; padding:0; border:0; background:transparent; cursor:pointer; }
  .chart-bar:focus-visible { outline:2px solid rgba(14,165,233,0.7); outline-offset:2px; border-radius:10px; }
  .chart-bar::after {
    content: attr(data-value);
    position:absolute;
    left:50%;
    bottom: calc(var(--bar-height, 0px) + 8px);
    transform: translateX(-50%);
    background:#0ea5e9;
    color:#fff;
    font-size:11px;
    font-weight:700;
    padding:4px 8px;
    border-radius:8px;
    box-shadow:0 8px 18px rgba(14,165,233,0.25);
    opacity:0;
    pointer-events:none;
    white-space:nowrap;
    transition:opacity 0.12s ease;
  }
  .chart-bar:hover::after,
  .chart-bar:focus-visible::after { opacity:1; }
  .chart-bar-fill { width:100%; border-radius:10px 10px 4px 4px; background:linear-gradient(180deg, rgba(59,130,246,0.85), rgba(59,130,246,0.25)); box-shadow:0 8px 18px rgba(59,130,246,0.15); }
  .line-chart-line { fill:none; stroke:#0ea5e9; stroke-width:3; stroke-linecap:round; filter:drop-shadow(0 6px 12px rgba(14,165,233,0.2)); pointer-events:none; }
  .line-chart-area { fill:url(#lineArea); pointer-events:none; }
  .line-chart-dot { fill:#fff; stroke:#facc15; stroke-width:2.5; cursor:pointer; pointer-events:all; }
  .line-chart-dot.is-peak { fill:#fef3c7; stroke:#f59e0b; stroke-width:3; }
  .line-chart-y { position:absolute; inset:0; pointer-events:none; }
  .line-chart-y span { position:absolute; left:12px; transform:translateY(-50%); font-size:11px; color:#64748b; background:transparent; }
  .line-chart-x { display:flex; justify-content:space-between; gap:12px; margin-top:8px; padding:0 6px; }
  .line-chart-x span { text-align:center; font-size:12px; color:#6b7280; white-space:nowrap; }
  .chart-tooltip { position:absolute; background:#0ea5e9; color:#fff; font-weight:700; padding:6px 10px; border-radius:10px; font-size:12px; box-shadow:0 10px 20px rgba(14,165,233,0.25); transform:translate(-50%, -100%); white-space:nowrap; z-index: 3; }
  .chart-tooltip::after { content:""; position:absolute; left:50%; bottom:-5px; transform:translateX(-50%); width:10px; height:10px; background:#0ea5e9; clip-path:polygon(50% 100%, 0 0, 100% 0); }
  .chart-tooltip.is-hidden { display:none; }
  .crm-section-head { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
  .crm-section-title { font-weight:700; color:#0f172a; }
  .crm-section-link { font-size:13px; color:#1e3a8a; text-decoration:none; font-weight:600; }
  .crm-strip { display:flex; gap:12px; overflow-x:auto; padding:4px 2px 10px; scroll-snap-type:x mandatory; -ms-overflow-style:none; scrollbar-width:none; }
  .crm-strip::-webkit-scrollbar { display:none; }
  .crm-tile { flex:0 0 auto; width:200px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:14px; padding:12px; scroll-snap-align:start; box-shadow:0 6px 14px rgba(15,23,42,0.06); }
  .crm-tile-title { font-weight:700; font-size:14px; color:#111827; margin-bottom:6px; }
  .crm-tile-meta { font-size:12px; color:#64748b; }
  .courier-strip { display:flex; gap:12px; overflow-x:auto; padding:4px 2px 10px; scroll-snap-type:x mandatory; -ms-overflow-style:none; scrollbar-width:none; }
  .courier-strip::-webkit-scrollbar { display:none; }
  .courier-chip { flex:0 0 auto; width:110px; text-align:center; scroll-snap-align:center; }
  .courier-chip .avatar { width:70px; height:70px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#0f172a; background:#e2e8f0; border:3px solid #fff; box-shadow:0 8px 18px rgba(0,0,0,0.12); margin:0 auto 6px; }
  .courier-chip .name { font-weight:600; font-size:12px; color:#111; }
  .courier-chip .meta { font-size:11px; color:#64748b; }
  @media (max-width: 576px) {
    .weekly-chart { height:150px; gap:8px; }
    .weekly-bar .bar { max-width:22px; }
    .weekly-bar .label { font-size:10px; }
    .weekly-bar .value { font-size:9px; }
    .courier-chip { width:90px; }
    .courier-chip .avatar { width:64px; height:64px; }
    .line-chart-card { padding: 16px; border-radius: 18px; }
    .line-chart-title { font-size: 18px; }
    .line-chart-canvas { height: 200px; }
    .chart-bars { inset: 16px 12px 24px 12px; gap: 8px; }
    .line-chart-y span { font-size: 10px; left: 6px; }
    .chart-tooltip { display: none; }
    .line-chart-x { gap: 10px; padding: 0 4px; }
    .line-chart-x::-webkit-scrollbar { height: 8px; }
    .line-chart-x::-webkit-scrollbar-track { background: transparent; }
    .line-chart-x::-webkit-scrollbar-thumb {
      background-color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      box-shadow: inset 0 2px 3px rgba(255,255,255,0.9), inset 0 -2px 3px rgba(148,163,184,0.6);
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='36' viewBox='0 0 120 36'><rect x='6' y='6' width='108' height='24' rx='12' fill='%23eef2f7'/><path d='M24 18h72' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round'/><path d='M30 12l-6 6 6 6' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/><path d='M90 12l6 6-6 6' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>");
      background-repeat: no-repeat;
      background-position: center;
      background-size: 70px 20px;
    }
    .line-chart-x { scrollbar-width: thin; scrollbar-color: #e5e7eb transparent; }
    .chart-bars { grid-template-columns: repeat(var(--chart-cols, 13), minmax(16px, 1fr)); gap: 6px; inset: 14px 10px 24px 10px; }
    .chart-bar-fill { border-radius: 8px 8px 3px 3px; }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const chart = document.getElementById("hourly-chart");
    const tooltip = document.getElementById("chart-click-tooltip");
    if (!chart || !tooltip) return;

    function showTooltip(target) {
      const value = target.getAttribute("data-value");
      if (!value) return;
      const rect = chart.getBoundingClientRect();
      const dotRect = target.getBoundingClientRect();
      const x = dotRect.left - rect.left + dotRect.width / 2;
      const y = dotRect.top - rect.top - 6;
      tooltip.textContent = value;
      tooltip.style.left = `${x}px`;
      tooltip.style.top = `${y}px`;
      tooltip.classList.remove("is-hidden");
    }

    function hideTooltip() {
      tooltip.classList.add("is-hidden");
    }

    chart.addEventListener("click", function (event) {
      const target = event.target;
      const dot = target && target.closest ? target.closest(".line-chart-dot") : null;
      if (dot) {
        showTooltip(dot);
      } else {
        hideTooltip();
      }
    });

    chart.addEventListener("mouseleave", hideTooltip);
  })();
</script>
{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
  <h4 class="mb-0">Dashboard</h4>
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-sm btn-outline-primary" href="{% url 'crm_export_report_pdf' %}">Hisobot PDF</a>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-12">
    <div class="line-chart-card">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div class="line-chart-title">Soatlik tushum</div>
        <div class="text-muted">Bugun 08:00-20:00</div>
      </div>
      <div class="line-chart" style="--chart-cols: {{ hourly_data|length }};">
        <div class="line-chart-canvas" id="hourly-chart">
          <div class="line-chart-y">
            {% for tick in chart_ticks %}
            <span style="top: {{ tick.y }}px;">{{ tick.value|floatformat:0|intcomma }}</span>
            {% endfor %}
          </div>
          <div class="chart-tooltip is-hidden" id="chart-click-tooltip"></div>
          <div class="chart-bars" aria-hidden="true">
            {% for day in hourly_data %}
            <button class="chart-bar" type="button" data-value="{{ day.income|floatformat:0|intcomma }} so'm" style="--bar-height: {{ day.income_height }}px;">
              <span class="chart-bar-fill" style="height: {{ day.income_height }}px;"></span>
            </button>
            {% endfor %}
          </div>
          {% if chart_peak %}
          <div class="chart-tooltip" style="left: {{ chart_peak.x }}px; top: {{ chart_peak.y }}px;">
            {{ chart_peak.value|floatformat:0|intcomma }}
          </div>
          {% endif %}
          <svg viewBox="0 0 700 200" preserveAspectRatio="none" aria-hidden="true">
            <defs>
              <linearGradient id="lineArea" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#7dd3fc" stop-opacity="0.3"></stop>
                <stop offset="100%" stop-color="#7dd3fc" stop-opacity="0.02"></stop>
              </linearGradient>
            </defs>
            <polygon class="line-chart-area" points="{{ chart_points }} 680,170 50,170"></polygon>
            <polyline class="line-chart-line" points="{{ chart_points }}"></polyline>
            {% for dot in chart_dots %}
            <circle class="line-chart-dot {% if chart_peak and dot.x == chart_peak.x and dot.y == chart_peak.y %}is-peak{% endif %}" cx="{{ dot.x }}" cy="{{ dot.y }}" r="5" data-value="{{ dot.value|floatformat:0|intcomma }} so'm">
              <title>{{ dot.value|floatformat:0|intcomma }} so'm</title>
            </circle>
            {% endfor %}
          </svg>
        </div>
        <div class="line-chart-x">
          {% if hourly_data %}
          <span>{{ hourly_data.0.label }}</span>
          {% with last_item=hourly_data|last %}
          <span>{{ last_item.label }}</span>
          {% endwith %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-2 g-md-4 mb-4 kpi-grid">
  <div class="col-6 col-md-3">
    <div class="card crm-card p-3 kpi-card kpi-amber">
      <div class="text-muted small">Bugungi buyurtmalar</div>
      <div class="crm-kpi">{{ orders_today|intcomma }}</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card crm-card p-3 kpi-card kpi-green">
      <div class="text-muted small">Bugungi tushum</div>
      <div class="crm-kpi">{{ revenue_today|floatformat:0|intcomma }} so'm</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card crm-card p-3 kpi-card kpi-blue">
      <div class="text-muted small">Haftalik buyurtmalar</div>
      <div class="crm-kpi">{{ weekly_orders|intcomma }}</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card crm-card p-3 kpi-card kpi-lilac">
      <div class="text-muted small">Haftalik tushum</div>
      <div class="crm-kpi">{{ weekly_revenue|floatformat:0|intcomma }} so'm</div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-12">
    <div class="card crm-card p-3">
      <div class="crm-section-head">
        <div class="crm-section-title">Eng ko'p sotilgan kitoblar</div>
        <a class="crm-section-link" href="{% url 'crm_orders' %}">Hammasi <i class="bi bi-chevron-right"></i></a>
      </div>
      <div class="crm-strip">
        {% for item in top_books %}
        <div class="crm-tile">
          <div class="crm-tile-title">{{ item.book__title }}</div>
          <div class="crm-tile-meta">Soni: {{ item.quantity|intcomma }}</div>
          <div class="crm-tile-meta">Tushum: {{ item.revenue|floatformat:0|intcomma }}</div>
        </div>
        {% empty %}
        <div class="text-muted">Ma'lumot yo'q</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div class="card crm-card p-3 mt-4">
  <div class="fw-semibold mb-2">Ma'lumotlar bazasini tozalash</div>
  <form method="post" action="{% url 'crm_cleanup' %}" class="row g-2 align-items-end">
    {% csrf_token %}
    <div class="col-md-4">
      <label class="form-label">Necha kundan eski</label>
      <input type="number" name="days" class="form-control" value="90" min="0" max="3650">
    </div>
    <div class="col-md-4">
      <label class="form-label">Qaysi buyurtmalar</label>
      <select name="scope" class="form-select">
        <option value="closed">Yopilgan/Bekor qilingan</option>
        <option value="all">Barchasi (to'langan ham)</option>
      </select>
    </div>
    <div class="col-md-4">
      <button class="btn btn-danger w-100 mt-4" type="submit">Tozalash</button>
    </div>
  </form>
</div>
{% endblock %}
