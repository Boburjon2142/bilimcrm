{% extends "crm/base.html" %}
{% load humanize %}

{% block title %}CRM Dashboard{% endblock %}

{% block extra_css %}
<style>
  .line-chart { width:100%; }
  .line-chart-title { font-weight:600; color:#0f172a; }
  .line-chart-canvas { position:relative; height:200px; margin-top:12px; background:linear-gradient(#e2e8f0 1px, transparent 1px); background-size:100% 40px; border-radius:12px; }
  .line-chart-canvas svg { position:absolute; inset:0; width:100%; height:100%; }
  .line-chart-line { fill:none; stroke:#3b82f6; stroke-width:3; }
  .line-chart-dot { fill:#3b82f6; stroke:#fff; stroke-width:2; }
  .line-chart-y { position:absolute; inset:0; pointer-events:none; }
  .line-chart-y span { position:absolute; left:6px; transform:translateY(-50%); font-size:10px; color:#64748b; background:#fff; padding:0 4px; }
  .line-chart-x { display:grid; grid-template-columns:repeat(auto-fit, minmax(38px, 1fr)); gap:12px; margin-top:6px; }
  .line-chart-x span { text-align:center; font-size:11px; color:#0f172a; }
  .crm-section-head { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
  .crm-section-title { font-weight:700; color:#0f172a; }
  .crm-section-link { font-size:13px; color:#1e3a8a; text-decoration:none; font-weight:600; }
  .crm-strip { display:flex; gap:12px; overflow-x:auto; padding:4px 2px 10px; scroll-snap-type:x mandatory; -ms-overflow-style:none; scrollbar-width:none; }
  .crm-strip::-webkit-scrollbar { display:none; }
  .crm-tile { flex:0 0 auto; width:200px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:14px; padding:12px; scroll-snap-align:start; box-shadow:0 6px 14px rgba(15,23,42,0.06); }
  .crm-tile-title { font-weight:700; font-size:14px; color:#111827; margin-bottom:6px; }
  .crm-tile-meta { font-size:12px; color:#64748b; }
  .courier-strip { display:flex; gap:12px; overflow-x:auto; padding:4px 2px 10px; scroll-snap-type:x mandatory; -ms-overflow-style:none; scrollbar-width:none; }
  .courier-strip::-webkit-scrollbar { display:none; }
  .courier-chip { flex:0 0 auto; width:110px; text-align:center; scroll-snap-align:center; }
  .courier-chip .avatar { width:70px; height:70px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#0f172a; background:#e2e8f0; border:3px solid #fff; box-shadow:0 8px 18px rgba(0,0,0,0.12); margin:0 auto 6px; }
  .courier-chip .name { font-weight:600; font-size:12px; color:#111; }
  .courier-chip .meta { font-size:11px; color:#64748b; }
  @media (max-width: 576px) {
    .weekly-chart { height:150px; gap:8px; }
    .weekly-bar .bar { max-width:22px; }
    .weekly-bar .label { font-size:10px; }
    .weekly-bar .value { font-size:9px; }
    .courier-chip { width:90px; }
    .courier-chip .avatar { width:64px; height:64px; }
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
  <h4 class="mb-0">Dashboard</h4>
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-sm btn-outline-primary" href="{% url 'crm_export_report_pdf' %}">Hisobot PDF</a>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-12">
    <div class="card crm-card p-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div class="line-chart-title">Soatlik tushum</div>
        <div class="text-muted small">Bugun 08:00-20:00</div>
      </div>
      <div class="line-chart">
        <div class="line-chart-canvas">
          <div class="line-chart-y">
            {% for tick in chart_ticks %}
            <span style="top: {{ tick.y }}px;">{{ tick.value|floatformat:0|intcomma }}</span>
            {% endfor %}
          </div>
          <svg viewBox="0 0 700 200" preserveAspectRatio="none" aria-hidden="true">
            <polyline class="line-chart-line" points="{{ chart_points }}"></polyline>
            {% for dot in chart_dots %}
            <circle class="line-chart-dot" cx="{{ dot.x }}" cy="{{ dot.y }}" r="4"></circle>
            {% endfor %}
          </svg>
        </div>
        <div class="line-chart-x">
          {% for day in hourly_data %}
          <span>{{ day.label }}</span>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-2 g-md-4 mb-4 kpi-grid">
  <div class="col-6 col-md-3">
    <div class="card crm-card p-3 kpi-card">
      <div class="text-muted small">Bugungi buyurtmalar</div>
      <div class="crm-kpi">{{ orders_today }}</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card crm-card p-3 kpi-card">
      <div class="text-muted small">Bugungi tushum</div>
      <div class="crm-kpi">{{ revenue_today|floatformat:0|intcomma }} so'm</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card crm-card p-3 kpi-card">
      <div class="text-muted small">Jami buyurtmalar</div>
      <div class="crm-kpi">{{ total_orders }}</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card crm-card p-3 kpi-card">
      <div class="text-muted small">Jami tushum</div>
      <div class="crm-kpi">{{ total_revenue|floatformat:0|intcomma }} so'm</div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-12">
    <div class="card crm-card p-3">
      <div class="crm-section-head">
        <div class="crm-section-title">Eng ko'p sotilgan kitoblar</div>
        <a class="crm-section-link" href="{% url 'crm_orders' %}">Hammasi <i class="bi bi-chevron-right"></i></a>
      </div>
      <div class="crm-strip">
        {% for item in top_books %}
        <div class="crm-tile">
          <div class="crm-tile-title">{{ item.book__title }}</div>
          <div class="crm-tile-meta">Soni: {{ item.quantity }}</div>
          <div class="crm-tile-meta">Tushum: {{ item.revenue|intcomma }}</div>
        </div>
        {% empty %}
        <div class="text-muted">Ma'lumot yo'q</div>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="col-12">
    <div class="card crm-card p-3">
      <div class="crm-section-head">
        <div class="crm-section-title">Eng faol mijozlar</div>
        <a class="crm-section-link" href="{% url 'crm_customers' %}">Hammasi <i class="bi bi-chevron-right"></i></a>
      </div>
      <div class="crm-strip">
        {% for customer in top_customers %}
        <div class="crm-tile">
          <div class="crm-tile-title">{{ customer.full_name }}</div>
          <div class="crm-tile-meta">LTV: {{ customer.total_spent|intcomma }}</div>
          <div class="crm-tile-meta">Buyurtmalar: {{ customer.orders_count }}</div>
        </div>
        {% empty %}
        <div class="text-muted">Ma'lumot yo'q</div>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="col-12">
    <div class="card crm-card p-3">
      <div class="crm-section-head">
        <div class="crm-section-title">Kuryerlar samaradorligi</div>
        <a class="crm-section-link" href="{% url 'crm_couriers' %}">Hammasi <i class="bi bi-chevron-right"></i></a>
      </div>
      <div class="courier-strip">
        {% for courier in courier_stats %}
        <div class="courier-chip">
          <div class="avatar">{{ courier.courier__name|slice:":2" }}</div>
          <div class="name">{{ courier.courier__name }}</div>
          <div class="meta">{{ courier.total }} ta</div>
        </div>
        {% empty %}
        <div class="text-muted">Ma'lumot yo'q</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div class="card crm-card p-3 mt-4">
  <div class="fw-semibold mb-2">Ma'lumotlar bazasini tozalash</div>
  <form method="post" action="{% url 'crm_cleanup' %}" class="row g-2 align-items-end">
    {% csrf_token %}
    <div class="col-md-4">
      <label class="form-label">Necha kundan eski</label>
      <input type="number" name="days" class="form-control" value="90" min="0" max="3650">
    </div>
    <div class="col-md-4">
      <label class="form-label">Qaysi buyurtmalar</label>
      <select name="scope" class="form-select">
        <option value="closed">Yopilgan/Bekor qilingan</option>
        <option value="all">Barchasi (to'langan ham)</option>
      </select>
    </div>
    <div class="col-md-4">
      <button class="btn btn-danger w-100 mt-4" type="submit">Tozalash</button>
    </div>
  </form>
</div>
{% endblock %}
