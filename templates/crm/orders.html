{% extends "crm/base.html" %}
{% load humanize %}

{% block title %}Buyurtmalar{% endblock %}

{% block extra_css %}
<style>
  @media (max-width: 768px) {
    .crm-orders table { border:0; }
    .crm-orders thead { display:none; }
    .crm-orders tbody, .crm-orders tr, .crm-orders td { display:block; width:100%; }
    .crm-orders tr { border:1px solid #e6e6e6; border-radius:12px; padding:10px 12px; margin-bottom:12px; background:#fff; }
    .crm-orders td { border:0; padding:6px 0; display:flex; justify-content:space-between; gap:12px; }
    .crm-orders td::before { content: attr(data-label); font-weight:600; color:#64748b; }
    .crm-orders .actions-cell { padding-top:10px; }
    .crm-orders .actions-cell::before { content: "Amal"; }
    .crm-orders .actions-cell form { width:100%; }
    .crm-orders .actions-cell select,
    .crm-orders .actions-cell button { width:100%; }
    .crm-orders .actions-cell .mt-2 { margin-top:8px !important; }
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
  <h4 class="mb-0">Buyurtmalar</h4>
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-sm btn-outline-primary" href="{% url 'crm_export_report_pdf' %}">Hisobot PDF</a>
    <form method="get" class="d-flex gap-2">
      <select name="status" class="form-select form-select-sm">
        <option value="">Barchasi</option>
        {% for value, label in statuses %}
        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-sm btn-outline-secondary" type="submit">Filter</button>
    </form>
  </div>
</div>

<div class="card crm-card p-3 crm-orders">
  <table class="table crm-table align-middle">
    <thead>
      <tr>
        <th>ID</th>
        <th>Mijoz</th>
        <th>Telefon</th>
        <th>Summa</th>
        <th>Kanal</th>
        <th>Status</th>
        <th>Kuryer</th>
        <th>Amal</th>
      </tr>
    </thead>
    <tbody>
      {% for order in orders %}
      <tr>
        <td data-label="ID">#{{ order.id }}</td>
        <td data-label="Mijoz">{{ order.full_name }}</td>
        <td data-label="Telefon">{{ order.phone }}</td>
        <td data-label="Summa">{{ order.total_price|floatformat:0|intcomma }}</td>
        <td data-label="Kanal">{{ order.get_order_source_display }}</td>
        <td data-label="Status">{{ order.get_status_display }}</td>
        <td data-label="Kuryer">{{ order.courier|default:"â€”" }}</td>
        <td class="actions-cell">
          {% if order.order_source != "pos" %}
          <form method="post" class="d-flex flex-wrap gap-2">
            {% csrf_token %}
            <input type="hidden" name="order_id" value="{{ order.id }}">
            <input type="hidden" name="action" value="status">
            <select name="status" class="form-select form-select-sm">
              {% for value, label in statuses %}
              <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-sm btn-outline-primary" type="submit">Yangilash</button>
          </form>
          <form method="post" class="d-flex flex-wrap gap-2 mt-2">
            {% csrf_token %}
            <input type="hidden" name="order_id" value="{{ order.id }}">
            <input type="hidden" name="action" value="assign">
            <select name="courier_id" class="form-select form-select-sm">
              <option value="">Kuryer tanlang</option>
              {% for courier in couriers %}
              <option value="{{ courier.id }}">{{ courier.name }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-sm btn-outline-success" type="submit">Biriktirish</button>
          </form>
          {% else %}
          <span class="text-muted small">POS (offline)</span>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="8" class="text-muted">Buyurtmalar yo'q</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
