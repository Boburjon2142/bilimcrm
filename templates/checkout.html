{% extends "base.html" %}
{% load humanize %}
{% block content %}
<h1 class="text-xl font-semibold text-slate-900">Buyurtma</h1>

<div class="mt-6 grid gap-6 lg:grid-cols-[1.2fr_0.8fr]">
  <form method="post" class="rounded-lg border border-slate-100 p-4">
    {% csrf_token %}
    {% if form.non_field_errors %}
    <div class="rounded-md border border-red-200 bg-red-50 p-3 text-xs text-red-600">
      {% for err in form.non_field_errors %}<div>{{ err }}</div>{% endfor %}
    </div>
    {% endif %}

    <div class="mt-4">
      <label class="text-xs font-semibold text-slate-500">To'liq ism sharif</label>
      <input type="text" name="full_name" value="{{ form.full_name.value|default_if_none:'' }}" class="mt-2 w-full rounded-md border border-slate-200 px-3 py-2 text-sm">
      {% if form.full_name.errors %}<div class="mt-1 text-xs text-red-600">{{ form.full_name.errors|striptags }}</div>{% endif %}
    </div>

    <div class="mt-4 grid gap-4 md:grid-cols-2">
      <div>
        <label class="text-xs font-semibold text-slate-500">Telefon</label>
        <input type="text" name="phone" value="{{ form.phone.value|default_if_none:'' }}" class="mt-2 w-full rounded-md border border-slate-200 px-3 py-2 text-sm">
        {% if form.phone.errors %}<div class="mt-1 text-xs text-red-600">{{ form.phone.errors|striptags }}</div>{% endif %}
      </div>
      <div>
        <label class="text-xs font-semibold text-slate-500">Qo'shimcha telefon</label>
        <input type="text" name="extra_phone" value="{{ form.extra_phone.value|default_if_none:'' }}" class="mt-2 w-full rounded-md border border-slate-200 px-3 py-2 text-sm">
        {% if form.extra_phone.errors %}<div class="mt-1 text-xs text-red-600">{{ form.extra_phone.errors|striptags }}</div>{% endif %}
      </div>
    </div>

    <div class="mt-4">
      <label class="text-xs font-semibold text-slate-500">Lokatsiya (ixtiyoriy)</label>
      <input type="text" name="location" value="{{ form.location.value|default_if_none:'' }}" class="mt-2 w-full rounded-md border border-slate-200 px-3 py-2 text-sm">
      {% if form.location.errors %}<div class="mt-1 text-xs text-red-600">{{ form.location.errors|striptags }}</div>{% endif %}
    </div>

    <div class="mt-4">
      <label class="text-xs font-semibold text-slate-500">Mo'ljal</label>
      <input type="text" name="address" value="{{ form.address.value|default_if_none:'' }}" class="mt-2 w-full rounded-md border border-slate-200 px-3 py-2 text-sm">
      {% if form.address.errors %}<div class="mt-1 text-xs text-red-600">{{ form.address.errors|striptags }}</div>{% endif %}
    </div>

    {% if delivery_notices %}
    <div class="mt-4 rounded-md border border-blue-100 bg-blue-50 p-3 text-xs text-slate-700">
      <div class="font-semibold text-slate-900">Yetkazib berish ma'lumoti</div>
      <ul class="mt-2 list-disc pl-4">
        {% for notice in delivery_notices %}
        <li><strong>{{ notice.title }}:</strong> {{ notice.body }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <input type="hidden" name="latitude" id="id_latitude" value="{{ form.latitude.value|default_if_none:'' }}">
    <input type="hidden" name="longitude" id="id_longitude" value="{{ form.longitude.value|default_if_none:'' }}">

    <div class="mt-4">
      <div class="flex items-center justify-between">
        <label class="text-xs font-semibold text-slate-500">Lokatsiyani xaritada belgilang (ixtiyoriy)</label>
        <button type="button" class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:border-blue-200 hover:text-blue-600" id="open-google-maps">Google Maps'da ochish</button>
      </div>
      <div id="order-map" class="mt-2 h-72 w-full rounded-lg border border-slate-100 bg-slate-50" data-default-lat="{{ origin_lat }}" data-default-lng="{{ origin_lng }}"></div>
      <p class="mt-2 text-xs text-slate-500">Xaritaga bosib nuqta tanlang â€” koordinata va Google Maps havolasi avtomatik to'ldiriladi.</p>
      <div class="mt-2 text-xs text-red-600" id="map-error"></div>
      <div id="delivery-quote" class="mt-2 rounded-md border border-slate-100 bg-slate-50 p-2 text-xs text-slate-600"></div>
    </div>

    <div class="mt-4">
      <label class="text-xs font-semibold text-slate-500">Google Maps havolasi (ixtiyoriy)</label>
      <input type="url" name="maps_link" id="id_maps_link" value="{{ form.maps_link.value|default_if_none:'' }}" class="mt-2 w-full rounded-md border border-slate-200 px-3 py-2 text-sm">
    </div>

    <div class="mt-4">
      <label class="text-xs font-semibold text-slate-500">Izoh</label>
      <textarea name="note" rows="3" class="mt-2 w-full rounded-md border border-slate-200 px-3 py-2 text-sm">{{ form.note.value|default_if_none:'' }}</textarea>
      {% if form.note.errors %}<div class="mt-1 text-xs text-red-600">{{ form.note.errors|striptags }}</div>{% endif %}
    </div>

    <div class="mt-4">
      <label class="text-xs font-semibold text-slate-500">To'lov turi</label>
      <select name="payment_type" class="mt-2 w-full rounded-md border border-slate-200 px-3 py-2 text-sm">
        {% for value, label in form.fields.payment_type.choices %}
        <option value="{{ value }}" {% if form.payment_type.value == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      {% if form.payment_type.errors %}<div class="mt-1 text-xs text-red-600">{{ form.payment_type.errors|striptags }}</div>{% endif %}
    </div>

    <button class="mt-5 w-full rounded-full bg-blue-600 px-5 py-2 text-sm font-semibold text-white hover:bg-blue-700" type="submit">Buyurtma berish</button>
  </form>

  <div class="rounded-lg border border-slate-100 p-4">
    <h2 class="text-sm font-semibold text-slate-900">Buyurtma yig'indisi</h2>
    <div class="mt-4 space-y-3">
      {% for item in cart_items %}
      <div class="flex items-center justify-between text-sm">
        <div>
          <div class="font-semibold text-slate-900">{{ item.book.title }}</div>
          <div class="text-xs text-slate-500">x{{ item.quantity }}</div>
        </div>
        <span>{{ item.line_total|floatformat:0|intcomma }} so'm</span>
      </div>
      {% endfor %}
    </div>
    <div class="mt-4 flex items-center justify-between border-t border-slate-100 pt-3 text-sm font-semibold text-slate-900">
      <span>Umumiy</span>
      <span id="checkout-subtotal" data-subtotal="{{ cart_total|floatformat:0 }}">{{ cart_total|floatformat:0|intcomma }} so'm</span>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const latInput = document.getElementById("id_latitude");
  const lngInput = document.getElementById("id_longitude");
  const mapError = document.getElementById("map-error");
  const mapBox = document.getElementById("order-map");
  const mapsInput = document.getElementById("id_maps_link");
  const openMapsBtn = document.getElementById("open-google-maps");
  const quoteBox = document.getElementById("delivery-quote");
  const subtotalEl = document.getElementById("checkout-subtotal");
  if (!latInput || !lngInput || !mapBox) return;

  const defaultLat = parseFloat(mapBox.dataset.defaultLat) || 41.2995;
  const defaultLng = parseFloat(mapBox.dataset.defaultLng) || 69.2401;
  let centerLat = parseFloat(latInput.value);
  let centerLng = parseFloat(lngInput.value);
  if (!isFinite(centerLat) || !isFinite(centerLng)) {
    centerLat = defaultLat;
    centerLng = defaultLng;
    latInput.value = centerLat.toFixed(6);
    lngInput.value = centerLng.toFixed(6);
    setMapsLinkFromCoords();
  }
  const zoom = 13;

  function formatSum(sum) {
    const value = Math.round(Number(sum) || 0);
    return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }

  function fetchQuote() {
    if (!quoteBox) return;
    if (!latInput.value || !lngInput.value) {
      quoteBox.textContent = "";
      return;
    }
    const subtotal = subtotalEl ? subtotalEl.dataset.subtotal : "0";
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch("{% url 'delivery_quote' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrftoken,
      },
      body: new URLSearchParams({
        lat: latInput.value,
        lng: lngInput.value,
        subtotal: subtotal,
      }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.error) {
          quoteBox.textContent = data.error;
        } else {
          quoteBox.textContent = `Yetkazib berish: ${formatSum(data.fee)} so'm | Masofa: ${Number(data.distance_km || 0).toFixed(2)} km`;
        }
      })
      .catch(() => {
        quoteBox.textContent = "Yetkazib berish narxini hisoblab bo'lmadi.";
      });
  }

  function setMapsLinkFromCoords() {
    if (!mapsInput) return;
    if (latInput.value && lngInput.value) {
      mapsInput.value = `https://www.google.com/maps?q=${latInput.value},${lngInput.value}`;
    }
  }

  (function initLeaflet() {
    const leafletCss = document.createElement("link");
    leafletCss.rel = "stylesheet";
    leafletCss.href = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
    leafletCss.crossOrigin = "";
    document.head.appendChild(leafletCss);

    const leafletJs = document.createElement("script");
    leafletJs.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
    leafletJs.crossOrigin = "";
    leafletJs.onload = buildLeafletMap;
    leafletJs.onerror = buildStaticFallback;
    document.head.appendChild(leafletJs);
  })();

  function buildLeafletMap() {
    if (typeof L === "undefined") return buildStaticFallback();
    try {
      const map = L.map("order-map").setView([centerLat, centerLng], zoom);
      map.zoomControl.setPosition("topright");
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap",
      }).addTo(map);
      let marker = L.marker([centerLat, centerLng]).addTo(map);
      map.on("click", function (e) {
        const { lat, lng } = e.latlng;
        latInput.value = lat.toFixed(6);
        lngInput.value = lng.toFixed(6);
        centerLat = lat;
        centerLng = lng;
        if (marker) marker.setLatLng([lat, lng]);
        else marker = L.marker([lat, lng]).addTo(map);
        if (mapError) mapError.textContent = "";
        setMapsLinkFromCoords();
        fetchQuote();
      });
    } catch (err) {
      buildStaticFallback();
    }
  }

  function buildStaticFallback() {
    const mapContainer = mapBox;
    mapContainer.innerHTML = "";
    const img = document.createElement("img");
    img.alt = "Xarita";
    img.className = "h-full w-full object-cover";
    img.referrerPolicy = "no-referrer";
    img.src = `https://staticmap.openstreetmap.de/staticmap.php?center=${centerLat},${centerLng}&zoom=${zoom}&size=900x450&markers=${centerLat},${centerLng},red-pushpin`;
    mapContainer.appendChild(img);

    const tileSize = 256;
    const scale = () => tileSize * Math.pow(2, zoom);
    const lonToX = (lon) => ((lon + 180) / 360) * scale();
    const latToY = (lat) => {
      const rad = (lat * Math.PI) / 180;
      return ((1 - Math.log(Math.tan(rad) + 1 / Math.cos(rad)) / Math.PI) / 2) * scale();
    };
    const xyToLatLng = (x, y) => {
      const n = Math.PI - (2 * Math.PI * y) / scale();
      const lat = (180 / Math.PI) * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n)));
      const lng = (x / scale()) * 360 - 180;
      return { lat, lng };
    };

    mapContainer.addEventListener("click", function (e) {
      const rect = img.getBoundingClientRect();
      const dx = e.clientX - rect.left - rect.width / 2;
      const dy = e.clientY - rect.top - rect.height / 2;
      const scaleFactorX = (img.naturalWidth || rect.width) / rect.width;
      const scaleFactorY = (img.naturalHeight || rect.height) / rect.height;
      const centerX = lonToX(centerLng);
      const centerY = latToY(centerLat);
      const worldX = centerX + dx * scaleFactorX;
      const worldY = centerY + dy * scaleFactorY;
      const { lat, lng } = xyToLatLng(worldX, worldY);
      latInput.value = lat.toFixed(6);
      lngInput.value = lng.toFixed(6);
      centerLat = lat;
      centerLng = lng;
      img.src = `https://staticmap.openstreetmap.de/staticmap.php?center=${lat.toFixed(6)},${lng.toFixed(6)}&zoom=${zoom}&size=900x450&markers=${lat.toFixed(6)},${lng.toFixed(6)},red-pushpin`;
      if (mapError) mapError.textContent = "";
      setMapsLinkFromCoords();
      fetchQuote();
    });
  }

  if (openMapsBtn) {
    openMapsBtn.addEventListener("click", () => {
      const url = mapsInput && mapsInput.value
        ? mapsInput.value
        : (latInput.value && lngInput.value ? `https://www.google.com/maps?q=${latInput.value},${lngInput.value}` : "https://www.google.com/maps");
      window.open(url, "_blank", "noopener");
    });
  }
});
</script>
{% endblock %}
